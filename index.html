<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" crossorigin="anonymous">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <title>Smart DEPOT Check In-OUT</title>
  </head>
  <body>
    <center>
      <h1>Check-In/Out Log</h1>
      <p>กดปุ่มด้านล่าง เพื่อบันทึกการลงเข้า </p>
      <div id="cin" class="visible">
        <button type="button" class="btn btn-success" onclick="getLocation('In')">Check-In</button>
      </div>
      <p>กดปุ่ม เพื่อบันทึกเวลาออก </p>
      <div id="cout" class="visible">
        <button id="cout" type="button" class="btn btn-danger" onclick="getLocation('Out')">Check-Out</button>
      </div>
      <p id="demo"></p>
    </center>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      window.onload = function() {
        initializeLiff('2002564550-0QeEewBw');
      }

      const xurl = "https://script.google.com/macros/s/AKfycbwWV7pT9ajEMagYHF3lK0xIMsN7U6QkKq5IoQteOt1YtoUWF6MUpiRaGWYEtA_iZ3N0/exec";

      async function initializeLiff(myLiffId) {
        try {
          await liff.init({ liffId: myLiffId });
        } catch (err) {
          console.error(err);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to initialize LIFF',
          });
        }
      }

      var x = document.getElementById("demo");

      async function getLocation(type) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(async position => {
            await showPosition(position, type);
          });
        } else { 
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Geolocation is not supported by this browser.',
          });
        }
      }

      async function showPosition(position, type) {
        try {
          const profile = await liff.getProfile();
          const uid = profile.userId;
          const uname = profile.displayName;
          const xos = liff.getOS();

          x.innerHTML = `Lat: ${position.coords.latitude} 
                         <br>Long: ${position.coords.longitude} 
                         <br>userId: ${uid} 
                         <br>displayName: ${uname} 
                         <br>your OS: ${xos}`;

          const theUrl = `${xurl}?ctype=${type}&xos=${xos}&user=${uid}&name=${uname}&lat=${position.coords.latitude}&long=${position.coords.longitude}`;
          const response = await fetch(theUrl);
          const jsonResponse = await response.json();

          if (jsonResponse.status === 'success') {
            Swal.fire({
              icon: 'success',
              title: `ลงเวลา${type === 'In' ? 'เข้า' : 'ออก'} สำเร็จ`,
              confirmButtonText: 'OK'
            });
            sendFlexMessage(type === 'In' ? 'Check In' : 'Check Out', position.coords.latitude, position.coords.longitude);
          } else {
            Swal.fire({
              icon: 'error',
              title: `ลงเวลา${type === 'In' ? 'เข้า' : 'ออก'} ไม่สำเร็จ`,
              text: jsonResponse.desc,
              confirmButtonText: 'OK'
            });
            liff.closeWindow();
          }
        } catch (error) {
          console.error('Error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Something went wrong!',
          });
        }
      }

      async function sendFlexMessage(action, latitude, longitude) {
        const flexMessage = {
          type: 'flex',
          altText: `${action} Successful`,
          contents: {
            type: "bubble",
            body: {
              type: "box",
              layout: "vertical",
              contents: [
                {
                  type: "text",
                  text: `${action} Successful`,
                  weight: "bold",
                  size: "xl"
                },
                {
                  type: "text",
                  text: `Latitude: ${latitude}`,
                  size: "md"
                },
                {
                  type: "text",
                  text: `Longitude: ${longitude}`,
                  size: "md"
                }
              ]
            }
          }
        };

        try {
          await liff.sendMessages([{ type: 'text', text: `Checking ${action}...` }]);
          await liff.sendMessages([flexMessage]);
          console.log(`${action} reply message sent successfully`);
          Swal.fire({
            icon: 'success',
            title: 'Message Sent',
            text: `${action} reply message sent successfully`,
            showConfirmButton: false,
            timer: 1500
          });

          await liff.shareTargetPicker([flexMessage]);
          console.log(`${action} message shared successfully`);
          liff.closeWindow();
        } catch (err) {
          console.error('Error sending message: ', err);
          Swal.fire({
            icon: 'error',
            title: 'Message Send Failed',
            text: err.message,
          });
        }
      }
    </script>

    <!-- Optional JavaScript -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
  </body>
</html>
